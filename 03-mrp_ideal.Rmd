
# Ideal-Point MRP

Introduction

## Ideal Point Model

We've seen the CCES includes 6 questions on abortion:

* A: CC18_321a Always allow a woman to obtain an abortion as a matter of choice
* B: CC18_321b Permit abortion ONLY in case of rape, incest or when the woman’s life is in danger
* C: CC18_321c Ban abortions after the 20th week of pregnancy
* D: CC18_321d Allow employers to decline coverage of abortions in insurance plans
* E: CC18_321e Prohibit the expenditure of funds authorized or appropriated by federal law for any abortion
* F: CC18_321f Make abortions illegal in all circumstances

For $J$ subjects and $K$ questions, we can use a two-parameter logistic item response model with latent (multilevel) regression:

$$
\begin{equation*}
P(y_i = 1) = logit^{-1}(\gamma_{k[i]}(\alpha_{j[i]} - \beta_{k[i]}))
\end{equation*}
$$
where:

$$
\begin{align*}
\alpha_j &\sim {\rm Normal}(\mu^{\alpha} + A_{\rm s[j]}^{\rm state}
+ A_{\rm a[j]}^{\rm age}
+ A_{\rm r[j]}^{\rm ethnicity}
+ A_{\rm e[j]}^{\rm education}
+ B^{\rm male} \cdot {\rm Male}_{\rm j}, \sigma^{\alpha}) {\rm \ for} \ j = 1,...,J \\
\beta_k &\sim {\rm Normal}(\mu^{\beta}, \sigma^{\beta}) {\rm \ for} \ k = 1,...,K
\end{align*}
$$
and:

$$
\begin{align*}
A_{\rm s}^{\rm state} &\sim {\rm Normal}(A^{\rm region}_{n[s]} + B^{\rm repvote} \cdot {\rm RepVote}_{\rm s}, \sigma^{\rm state}) \textrm{ for s = 1,...,50}\\
A_{\rm a}^{\rm age} & \sim {\rm Normal}(0,\sigma^{\rm age}) \textrm{ for a = 1,...,6}\\
A_{\rm r}^{\rm ethnicity} & \sim {\rm Normal}(0,\sigma^{\rm ethnicity}) \textrm{ for r = 1,...,4}\\
A_{\rm e}^{\rm education} & \sim {\rm Normal}(0,\sigma^{\rm education}) \textrm{ for e = 1,...,5}\\
A_{\rm n}^{\rm region} & \sim {\rm Normal}(0,\sigma^{\rm region}) \textrm{ for a = 1,...,4}\\
\end{align*}
$$

The indeterminacies in the model are resolved by: 

+ (i) We can deal with additive and multiplicative aliasing by setting $\mu^{\alpha} = 0$ and $\sigma^{\alpha} = 1$. This implies $\alpha_j \sim {\rm Normal}(0, 1)$, which also makes the latent abilities easier to interpret.

+ (ii) We restrict $\gamma_{k}>0$ to avoid reflection invariance. This requires precoding the outcome so that all the questions correspond to conservative positions (i.e. positions that limit abortions in some way).

### Fitting ideal point model

In this initial experiment I only include question 2 to 6, ignoring question 1 which we have seen can be problematic (and would require precoding). I analyzed a random sample of 5000 CCES participants. The Stan code we use is shown below, and was fitted using 5 chains with 1000 iterations (400 warmup).

```{stan, eval=FALSE, output.var="idealpointmodel"}
data {
  int<lower=1> J; //Participants
  int<lower=1> K; //Questions
  int<lower=1> N; //no. of observations
  int<lower=1> S; //no. of states
  int<lower=1, upper=J> participant[N]; // Participant for observation n
  int<lower=1, upper=K> question[N]; // Question for observation n
  int<lower=1, upper=S> state[N]; // State for observation n
  int<lower=1, upper=6> age[N]; // Age for observation n
  int<lower=1, upper=4> ethnicity[N]; // Ethnicity for observation n
  int<lower=1, upper=5> educ[N]; // Education for observation n
  real<lower=-0.5, upper=0.5> male[N]; // Gender for observation n
  int<lower=0, upper=4> region[S]; // Region for state s
  real repvote[S]; // Republican voteshare for state s
  int<lower=0, upper=1> y[N]; // Support for observation n
}
parameters {
  vector[S] alpha_state_raw;
  vector[6] alpha_age_raw;
  vector[5] alpha_educ_raw;
  vector[4] alpha_ethnicity_raw;
  vector[4] alpha_region_raw;
  real beta_male;
  real beta_repvote;
  real<lower=0> sigma_state;
  real<lower=0> sigma_age;
  real<lower=0> sigma_ethnicity;
  real<lower=0> sigma_educ;
  real<lower=0> sigma_region;

  //real mu_alpha;
  //real<lower=0> sigma_alpha;
  real mu_beta;
  real<lower=0> sigma_beta;

  vector[K] beta_raw;
  vector[J] alpha_raw;
  vector<lower=0>[K] theta;
}
transformed parameters{
  vector[6] alpha_age = 0 + sigma_age*alpha_age_raw;
  vector[5] alpha_educ = 0 + sigma_educ*alpha_educ_raw;
  vector[4] alpha_ethnicity = 0 + sigma_ethnicity*alpha_ethnicity_raw;
  vector[4] alpha_region = 0 + sigma_region*alpha_region_raw;
  vector[K] beta = mu_beta + sigma_beta*beta_raw;

  vector[S] alpha_state;
  vector[J] alpha;

  real mu_alpha = 0; // constraint on mu_alpha
  real sigma_alpha = 1; // constraint on sigma_alpha

  for(s in 1:S)
    alpha_state[s] = alpha_region[region[s]] + beta_repvote*repvote[s] + sigma_state*alpha_state_raw[s];
  for (j in 1:J)
    alpha[j] = mu_alpha + alpha_state[state[j]] + alpha_age[age[j]] + alpha_ethnicity[ethnicity[j]] + alpha_educ[educ[j]] + beta_male*male[j] + sigma_alpha*alpha_raw[j];
}

model {
  //priors on predictors
  sigma_state ~ exponential(0.5); // prior for sigma_state
  sigma_age ~ exponential(0.5); // prior for sigma_age
  sigma_ethnicity ~ exponential(0.5); // prior for sigma_ethnicity
  sigma_educ ~ exponential(0.5); // prior for sigma_educ
  sigma_region ~ exponential(0.5); // prior for sigma_educ
  beta_male ~ normal(0, 2); // prior for beta_male
  beta_repvote ~ normal(0, 2); // prior for beta_repvote

  //priors on parameters
  mu_beta ~ normal(0, 2); // prior for mu_beta
  sigma_beta ~ exponential(0.5); // prior for sigma_beta
  theta ~ normal(0, 1); // prior for theta

  alpha_state_raw ~ std_normal(); // implies alpha_state ~ normal(alpha_region, sigma_state)
  alpha_age_raw ~ std_normal(); // implies alpha_age ~ normal(0, sigma_age)
  alpha_ethnicity_raw ~ std_normal(); // implies alpha_ethnicity ~ normal(0, sigma_ethnicity)
  alpha_educ_raw ~ std_normal(); // implies alpha_educ ~ normal(0, sigma_educ)
  alpha_region_raw ~ std_normal(); // implies alpha_region ~ normal(0, sigma_region)

  beta_raw ~ std_normal(); // implies beta ~ normal(mu_beta, sigma_beta)
  alpha_raw ~ std_normal(); // implies alpha ~ normal(mu_alpha + alpha_state + alpha_age + ..., sigma_alpha)
  for (n in 1:N)
    y[n] ~ bernoulli_logit(theta[question[n]] * (alpha[participant[n]] - beta[question[n]]));
}

generated quantities{
  vector[S*6*5*4*2] alpha_pred;
  vector[S*6*5*4*2] abortion1_pred;
  vector[S*6*5*4*2] abortion2_pred;
  vector[S*6*5*4*2] abortion3_pred;
  vector[S*6*5*4*2] abortion4_pred;
  vector[S*6*5*4*2] abortion5_pred;

  for (st in 1:S)
    for (ag in 1:6)
      for (ed in 1:5)
        for (et in 1:4)
          for (ge in 1:2)
            alpha_pred[1 + (st-1)*12000/50 + (ag-1)*12000/50/6 + (ed-1)*12000/50/6/5 + (et-1)*12000/50/6/5/4 + (ge-1)*12000/50/6/5/4/2] = mu_alpha +
              alpha_state[st] + alpha_age[ag] + alpha_ethnicity[et] + alpha_educ[ed] + beta_male*(ge-1.5);

  abortion1_pred = inv_logit(theta[1]*(alpha_pred - beta[1]));
  abortion2_pred = inv_logit(theta[2]*(alpha_pred - beta[2]));
  abortion3_pred = inv_logit(theta[3]*(alpha_pred - beta[3]));
  abortion4_pred = inv_logit(theta[4]*(alpha_pred - beta[4]));
  abortion5_pred = inv_logit(theta[5]*(alpha_pred - beta[5]));
}
```

```{r setup, include=FALSE}
library(data.table)
library(dplyr)
library(forcats)
library(tidyr)
library(reshape2)
library(stringr)
library(ggplot2)
library(rstan)
library(rstanarm)
library(usmap)
library(gridExtra)
library(scales)

#Sys.setenv(LOCAL_CPPFLAGS = '-march=corei7 -mtune=corei7')
options(mc.cores = parallel::detectCores(logical = FALSE))
```

```{r, echo = FALSE, include = FALSE}
clean_cces <- function(df, list_states_abb, list_states_num){
  
  ## Abortion -- dichotomous (0 - Oppose / 1 - Support)
  df$abortion1 <- abs(df$CC18_321b-2)
  df$abortion2 <- abs(df$CC18_321c-2)
  df$abortion3 <- abs(df$CC18_321d-2)
  df$abortion4 <- abs(df$CC18_321e-2)
  df$abortion5 <- abs(df$CC18_321f-2)
  
  ## State -- factor
  df$state <- df$inputstate
  df$state <- factor(df$state, levels = list_states_num, labels = list_states_abb, ordered = TRUE)
  
  ## Gender -- dichotomous (-0.5 Female, +0.5 Male)
  df$male <- abs(df$gender-2)-0.5
  
  ## ethnicity -- factor
  df$ethnicity <- factor(df$race, 
                    levels = 1:8, 
                    labels = c("White", "Black", "Hispanic", "Asian", "Native American", "Mixed", "Other", "Middle Eastern"),
                    ordered = TRUE)
  df$ethnicity <- fct_collapse(df$ethnicity, "Other" = c("Asian", "Other", "Middle Eastern", "Mixed", "Native American"))
  
  ## Age -- cut into factor
  df$age <- 2018 - df$birthyr
  df$age <- cut(as.integer(df$age), breaks = c(0, 29, 39, 49, 59, 69, 120), 
                labels = c("18-29","30-39","40-49","50-59","60-69","70+"),
                ordered_result = TRUE)
  
  ## Education -- factor
  df$educ <- factor(as.integer(df$educ), 
                    levels = 1:6, 
                    labels = c("No HS", "HS", "Some college", "Associates", "4-Year College", "Post-grad"), ordered = TRUE)
  df$educ <- fct_collapse(df$educ, "Some college" = c("Some college", "Associates"))  
  
  ## ideology -- factor
  df$ideology <- factor(as.integer(df$ideo5), 
                    levels = 1:6, 
                    labels = c("Very Liberal", "Liberal", "Moderate", "Conservative", "Very Conservative", "Not Sure"), ordered = TRUE)
  
  # Clean and remove NAs
  df <- df %>% select(abortion1, abortion2, abortion3, abortion4, abortion5, state, ethnicity, male, age, educ, ideology) %>% drop_na()
  
}

df_all <- read.csv("cces18_common_vv.csv")
list_states_abb <- datasets::state.abb
list_states_num <- c(1,2,4,5,6,8,9,10,12,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,44,45,46,47,48,49,50,51,53,54,55,56)
df_all <- clean_cces(df_all, list_states_abb, list_states_num)
set.seed(1010)
df <- df_all %>% sample_n(5000)
df$subject <- 1:nrow(df)
```

```{r, warning=FALSE, include = FALSE}
statelevel_predictors <- read.csv("statelevel_predictors.csv", header = TRUE)
statelevel_predictors$region <- factor(statelevel_predictors$region, ordered = TRUE)
statelevel_predictors$state <- factor(statelevel_predictors$state, levels = levels(df$state), ordered = TRUE)
statelevel_predictors$repvote <- (statelevel_predictors$repvote - mean(statelevel_predictors$repvote))/sd(statelevel_predictors$repvote)
df <- left_join(df, statelevel_predictors)

# Melt df for Stan
df_melted <- df %>% select(starts_with("abortion"), state, ethnicity, age, educ, male, region, subject) %>% 
  melt(id.vars = c("state", "age", "ethnicity", "educ", "male", "region", "subject"))
```

```{r, include = FALSE}
postrat_df <- read.csv('postrat_data.csv')
postrat_df$state <- factor(postrat_df$state, levels = list_states_num, labels = list_states_abb, ordered = TRUE)
postrat_df$ethnicity <- factor(postrat_df$eth, levels = levels(df$ethnicity), ordered = TRUE)
postrat_df$age <- factor(postrat_df$age, levels = levels(df$age), ordered = TRUE)
postrat_df$educ <- factor(postrat_df$educ, levels = levels(df$educ), ordered = TRUE)

postrat_df  <- postrat_df %>% arrange(state, age, educ, ethnicity, male)
```

```{r, echo=FALSE}
data <- list(J = length(unique(df_melted$subject)), 
             K = length(unique(df_melted$variable)), 
             N = nrow(df_melted), 
             S = nrow(statelevel_predictors),
             participant = as.numeric(df_melted$subject), 
             question = as.numeric(df_melted$variable), 
             state = as.numeric(df_melted$state),
             age = as.numeric(df_melted$age),
             ethnicity = as.numeric(df_melted$ethnicity),
             educ = as.numeric(df_melted$educ),
             male = as.numeric(df_melted$male),
             region = as.numeric(statelevel_predictors$region),
             repvote = statelevel_predictors$repvote,
             y = df_melted$value)
# id_fit1b <- stan_model("idealpoint_solution1b.stan")
#  
# fit1b <- sampling(id_fit1b, data = data, iter = 1000, warmup = 400, chains = 5,
#                   control = list(adapt_delta = 0.99, max_treedepth = 12),
#                   refresh = 25)
# saveRDS(fit1b, file = "fit_idealpoint_solution1b.rds")

fit1b <- readRDS("fit_idealpoint_solution1b.rds")
```

```{r, echo=FALSE}
df_fit <- extract(fit1b)
```

### Initial Results

We can visualize the probability distribution for each $\alpha_j$:

```{r, echo=FALSE, fig.align = "center", fig.height=3.5, fig.width=7}
toplot <- data.frame(df_fit$alpha[,1:5])
colnames(toplot) <- c("alpha1", "alpha2","alpha3","alpha4","alpha5")

ggplot(data = melt(toplot, id.vars = NULL), aes(x = value)) + geom_histogram(bins = 50) + facet_grid(rows = vars(variable)) + theme_bw()
```

Conversely, we can visualize the distribution of $\alpha_j$ for a random subset of the posterior draws:

```{r, echo=FALSE, fig.align = "center", fig.height=3.5, fig.width=7}
toplot <- data.frame(t(df_fit$alpha[sample(nrow(df_fit$alpha),size=50),]))
ggplot(data = melt(toplot, id.vars = NULL), aes(x = value, color = variable)) + geom_density(alpha = 0.25) + scale_colour_grey() + guides(color=FALSE) + theme_bw()
```

As expected, we see a strong correlation between the estimated $\alpha_j$ and the ideology of subject $j$. 

```{r, echo=FALSE}
print(paste("Individual-level correlation with ideology:", round(cor(as.numeric(df$ideology), colMeans(df_fit$alpha)), 4)))
```

We can simulate the distribution for a random draw for $\alpha_j$ corresponding to people in California and Texas, giving us an approximation of the between-state and within-state variations. 

```{r, echo=FALSE, fig.align = "center", fig.height=3.5, fig.width=7}
ggplot(data = data.frame()) + 
  geom_density(data = data.frame(x = df_fit$alpha[1, df$state=="CA"]), aes(x = x), fill = "blue", alpha = 0.5) + 
  geom_density(data = data.frame(x = df_fit$alpha[1, df$state=="TX"]), aes(x = x), fill = "red", alpha = 0.5) + theme_bw()
```

Lastly, we can also visualize the probability of supporting each statement for the potential values of $\alpha_j$. 

```{r, echo=FALSE, fig.align = "center", fig.height=8, fig.width=12}
questions <- c("Permit abortion ONLY in case of rape, incest or when the woman’s life is in danger",
               "Ban abortions after the 20th week of pregnancy",
               "Allow employers to decline coverage of abortions in insurance plans",
               "Prohibit the expenditure of funds authorized or appropriated by federal law for any abortion",
               "Make abortions illegal in all circumstances")
plotlogistic <- function(question, n_draws){
    draws <- sample(1:3000, n_draws)
    outcome <- matrix(seq(-5, 5, by = .1))
    for(draw in draws){
      outcome <- cbind(outcome, df_fit$theta[draw,question] * (seq(-5, 5, by = .1) - df_fit$beta[draw, question]))
    }
    outcome <- melt(data.frame(outcome), id.vars = "X1")
    outcome$value <- plogis(outcome$value)
    plot <- ggplot(data = outcome, aes(x = X1, y = value, color = variable)) + geom_line() + scale_colour_grey() + guides(color=FALSE) +
      xlab(latex2exp::TeX("$\\alpha$")) + ylab(latex2exp::TeX("$P(y = 1)$")) + ggtitle(questions[question]) + theme_bw() + theme(plot.title = element_text(size=10)) 
    return(plot)
}

grid.arrange(plotlogistic(1, 50), plotlogistic(2, 50), plotlogistic(3, 50), plotlogistic(4, 50), plotlogistic(5, 50), ncol = 2)
```


## The Abortion Opposition Index for States

Instead of getting an estimate for the support of a particular question, the ideal point model allows to estimate the average $\alpha_j$ for each poststratification cell. Then, we can use poststratification as usual, obtaining state-level ideal points that represent what we can call an ‘Abortion Opposition Index'. It is important to clarify that interpretation is relative to the national level.

```{r, fig.height= 3, fig.width=12, echo=FALSE, fig.align = "center"}
national_level <- df_fit$alpha_pred %*% postrat_df$n / sum(postrat_df$n)

df_state <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$alpha_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]) ) - national_level
  df_state$state[i] <- s
  df_state$state_mean[i] <- mean(state_estimates)
  df_state$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

df_state$state <- fct_reorder(df_state$state, statelevel_predictors$repvote)

ggplot(data=df_state) +
  geom_hline(aes(yintercept = 0)) +
  geom_point(aes(x=state, y=state_mean)) +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0) +
  scale_y_continuous(limits = c(-0.6, 0.6),
                     expand=c(0,0)) +
  theme_bw()+
  labs(x="States",y="Abortion Opposition Index")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))
```


```{r, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=8, fig.align = "center"}
states_map <- us_map(regions = "states")
state_df_melted <- df_state %>% select(state, state_mean)
states_map  <- left_join(states_map, state_df_melted, by = c("abbr" = "state")) %>% drop_na()

ggplot(states_map, aes(x = x, y = y, group = group)) +
  geom_polygon(colour = "lightgray") +
  geom_polygon(aes(fill = state_mean)) + theme_void() + 
  scale_fill_gradient2(midpoint = 0, limits = c(-0.5, 0.5), breaks = c(-0.5, 0, 0.5),
                       name = "Abortion Opposition Index", low = muted("blue"), high = muted("red")) + 
  theme(legend.margin=margin(l = 0.5, unit='cm'))

```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
lk <- left_join(df_state, statelevel_predictors, by = "state")
print(paste("State-level correlation with 2016 Republican voteshare:", round(cor(lk$repvote, lk$state_mean), 2)))
```

## Estimating Statement Support

Secondly, we can transform the $\alpha_j$ for each $j$ row in the poststratification table into an estimate of the proportion of support of question $k$ based on the values of $\beta_k$ and $\gamma_k$. I will compare this ideal-point MRP estimates with the estimates from standard MRP and from the full survey. We will begin with question 5, which I think is an particularly interesting example.

### Question 5

```{r, echo=FALSE}
# fit_standard5 <- stan_glmer(abortion5 ~ (1 | state) + (1 | age) + (1 | ethnicity) + (1 | educ) + male +
#                      repvote + (1 | region),
#    family = binomial(link = "logit"),
#    data = left_join(df, statelevel_predictors),
#    prior = normal(0, 1, autoscale = TRUE),
#    prior_covariance = decov(scale = 0.50),
#    adapt_delta = 0.99,
#    seed = 1010)
# 
# saveRDS(fit_standard5, file = "fit_standard5.rds")
fit_standard5 <- readRDS("fit_standard5.rds")

P <- posterior_epred(fit_standard5, newdata = left_join(postrat_df, statelevel_predictors))
```

```{r, echo=FALSE}
national_level_standard <- P %*% postrat_df$n / sum(postrat_df$n)

df_state_standard <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (P[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]))
  df_state_standard$state[i] <- s
  df_state_standard$state_mean[i] <- mean(state_estimates)
  df_state_standard$state_sd[i] <- sd(state_estimates)
  i = i + 1
}


national_level_idealpoint <- df_fit$abortion5_pred %*% postrat_df$n / sum(postrat_df$n)

df_state_idealpoint <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$abortion5_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
  sum(postrat_df$n[which(postrat_df$state==s)]) )
  df_state_idealpoint$state[i] <- s
  df_state_idealpoint$state_mean[i] <- mean(state_estimates)
  df_state_idealpoint$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

national_level_all <- mean(df$abortion5)
df_state_all <- df_all %>% group_by(state) %>% summarise(state_mean = mean(abortion5), n = n())

```

> Make abortions illegal in all circumstances

We start considering that the national-level estimate for statement support using standard MRP is `r 100*round(mean(national_level_standard), 3)`%, which is quite close to the full unadjusted 60,000 survey, which gives `r 100*round(mean(df_all$abortion5), 3)`%. I don't have the expertise to know if this is a reasonable estimate or not, but what is clear to me is that it seems to be inconsistent with some of the other responses. Let's examine how the responses to question 5 compare with the ones to question 1 ('Permit abortion ONLY in case of rape, incest or when the woman’s life is in danger'):

```{r, echo=FALSE}
gmodels::CrossTable(df_all$abortion1, df_all$abortion5, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq=FALSE, 
                    digits = 1, format = "SPSS")
```

There is almost 4,000 people who support that abortions should be illegal in all circumstances, but that then claim that they should be allowed in case of rape, incest or when the woman’s life is in danger. If all these 4,000 people mistakenly answered question 5, and actually supported abortion in cases of rape, incest, or serious health risk, the proportion of people who actually wanted making abortions illegal in all circumstances would go down to 8.7%. Conversely, if these 4,000 people seriously wanted to make abortion illegal, and mistakenly answered question 1 wrong, the estimated national proportion of support for statement 5 would be 15.3%, as we have already seen. More realistically, the actual proportion of people who would vote for making abortions illegal in all circumstances would be something in between these two quantities.

There is nothing unique about comparing question 1 with question 5. In fact, we see the same trend when we compare question 5 with question 2 ('Ban abortions after the 20th week of pregnancy'):

```{r, echo=FALSE}
gmodels::CrossTable(df_all$abortion2, df_all$abortion5, prop.r = FALSE, prop.c = TRUE, prop.t = FALSE, prop.chisq=FALSE, 
                    digits = 1, format = "SPSS")
```

Again, we see that almost 1,800 people who supported making abortions illegal in all circumstances disagree with banning abortions after the 20th week of pregnancy.

Both naive and standard MRP estimates only consider responses to each question individually. Meanwhile, ideal-point MRP is able to consider how the questions relate to each other, providing estimates that may be higher or lower than those produced by standard MRP. For someone studying support for particular policies, I suppose the ideal-point MRPs could be seen as introducing (unwanted) bias. However, I assume people are sloppy when answering the survey and also may understand the questions a bit differently. In these situations, I think that ideal-point MRP may be able to produce more reasonable estimates by accounting for the responses to the other questions, at least in some cases. To me, a clear example is question 5, where standard MRP is taking the responses to the individual question too seriously -- even when a lot of these people are giving contradictory statements to other questions. Meanwhile, ideal point MRP is able to capture inconsistencies in the response patterns and, in this case, downweight the proportion of people who support banning abortion in all situation.

```{r, fig.height= 3.5, fig.width=12, echo=FALSE, fig.align = "center"}
df_state_standard$state <- fct_reorder(df_state_standard$state, statelevel_predictors$repvote)

compare1 <- ggplot(data=df_state_standard) +
  geom_point(aes(x=state, y=state_mean), color = "#E37B1C") +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0, color = "#E37B1C") +
  geom_point(data=df_state_idealpoint, aes(x=state, y=state_mean), color = "#7B1CE3") +
  geom_errorbar(data=df_state_idealpoint, 
                aes(ymin=state_mean - 2*state_sd, 
                    ymax=state_mean + 2*state_sd, 
                    x=state), 
                alpha=.5, width = 0, color = "#7B1CE3") +
  geom_point(data = df_state_all, aes(x=state, y=state_mean), color = "#1CE37B") +
  geom_errorbar(data = df_state_all, 
                aes(ymin=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    ymax=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    x=state), alpha=.5, width = 0, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1), 
                     labels=c("0%","25%","50%","75%","100%"), 
                     expand=c(0,0))+
  coord_cartesian(ylim=c(0, 1)) +
  theme_bw()+
  labs(x="States",y="Support")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

compare2 <- ggplot(data = data.frame())+
  geom_point(aes(y=mean(national_level_standard), x = .25), color = "#E37B1C") +
  geom_errorbar(aes(y = mean(national_level_standard), 
                x = .25,
                ymin = mean(national_level_standard) - 2*sd(national_level_standard),
                ymax = mean(national_level_standard) + 2*sd(national_level_standard)),
                width = 0, color = "#E37B1C") +
  geom_text(aes(x = Inf, y = mean(national_level_standard), label = "Standard MRP"), 
            hjust = -.05, size = 4, color = "#E37B1C") +
  geom_point(aes(y = mean(national_level_idealpoint), x = .75), color = "#7B1CE3") +
  geom_errorbar(aes(y = mean(national_level_idealpoint), 
                x = .75, 
                ymin = mean(national_level_idealpoint) - 2*sd(national_level_idealpoint),
                ymax = mean(national_level_idealpoint) + 2*sd(national_level_idealpoint)),
                width = 0, color = "#7B1CE3") +
  geom_text(aes(x = Inf, y = mean(national_level_idealpoint), label = "IdealPoint MRP"), 
            hjust = -.05, size = 4, color = "#7B1CE3") +
  geom_point(aes(y=national_level_all, x = .5), color = "#1CE37B") +
  geom_errorbar(aes(y = national_level_all, 
                x = .5, 
                ymin = national_level_all - 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all)),
                ymax = national_level_all + 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all))),
                width = 0, color = "#1CE37B") +
  geom_text(data = data.frame(), aes(x = Inf, y = national_level_all, label = "Complete Survey"), 
            hjust = -.06, size = 4, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1),
                     labels=c("0%","25%","50%","75%","100%"),
                     limits=c(0,1),expand=c(0,0))+
  scale_x_continuous(limits=c(0,1),expand=c(0,0), breaks=c(.25, .75)) +
  coord_cartesian(clip = 'off') +
  theme_bw()+
  labs(x="Population",y="")+
   theme(legend.position="none",
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=10, margin = margin(t = 19, r = 0, b = , l = 0)),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10),
        plot.margin = margin(5.5, 105, 5.5, 5.5, "pt")
        )

bayesplot::bayesplot_grid(compare1,compare2, 
               grid_args = list(nrow=1, widths = c(5,1.4)))
```

### Question 1

```{r, echo=FALSE}
# fit_standard1 <- stan_glmer(abortion1 ~ (1 | state) + (1 | age) + (1 | ethnicity) + (1 | educ) + male +
#                      repvote + (1 | region),
#    family = binomial(link = "logit"),
#    data = left_join(df, statelevel_predictors),
#    prior = normal(0, 1, autoscale = TRUE),
#    prior_covariance = decov(scale = 0.50),
#    adapt_delta = 0.99,
#    seed = 1010)
# 
# saveRDS(fit_standard1, file = "fit_standard1.rds")
fit_standard1 <- readRDS("fit_standard1.rds")

P <- posterior_epred(fit_standard1, newdata = left_join(postrat_df, statelevel_predictors))
```

```{r, echo=FALSE}
national_level_standard <- P %*% postrat_df$n / sum(postrat_df$n)

df_state_standard <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (P[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]))
  df_state_standard$state[i] <- s
  df_state_standard$state_mean[i] <- mean(state_estimates)
  df_state_standard$state_sd[i] <- sd(state_estimates)
  i = i + 1
}


national_level_idealpoint <- df_fit$abortion1_pred %*% postrat_df$n / sum(postrat_df$n)

df_state_idealpoint <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$abortion1_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
  sum(postrat_df$n[which(postrat_df$state==s)]) )
  df_state_idealpoint$state[i] <- s
  df_state_idealpoint$state_mean[i] <- mean(state_estimates)
  df_state_idealpoint$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

national_level_all <- mean(df$abortion1)
df_state_all <- df_all %>% group_by(state) %>% summarise(state_mean = mean(abortion1), n = n())

```

> Permit abortion ONLY in case of rape, incest or when the woman’s life is in danger

```{r, fig.height= 3.5, fig.width=12, echo=FALSE, fig.align = "center"}
df_state_standard$state <- fct_reorder(df_state_standard$state, statelevel_predictors$repvote)

compare1 <- ggplot(data=df_state_standard) +
  geom_point(aes(x=state, y=state_mean), color = "#E37B1C") +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0, color = "#E37B1C") +
  geom_point(data=df_state_idealpoint, aes(x=state, y=state_mean), color = "#7B1CE3") +
  geom_errorbar(data=df_state_idealpoint, 
                aes(ymin=state_mean - 2*state_sd, 
                    ymax=state_mean + 2*state_sd, 
                    x=state), 
                alpha=.5, width = 0, color = "#7B1CE3") +
  geom_point(data = df_state_all, aes(x=state, y=state_mean), color = "#1CE37B") +
  geom_errorbar(data = df_state_all, 
                aes(ymin=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    ymax=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    x=state), alpha=.5, width = 0, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1), 
                     labels=c("0%","25%","50%","75%","100%"), 
                     expand=c(0,0))+
  coord_cartesian(ylim=c(0, 1)) +
  theme_bw()+
  labs(x="States",y="Support")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

compare2 <- ggplot(data = data.frame())+
  geom_point(aes(y=mean(national_level_standard), x = .25), color = "#E37B1C") +
  geom_errorbar(aes(y = mean(national_level_standard), 
                x = .25,
                ymin = mean(national_level_standard) - 2*sd(national_level_standard),
                ymax = mean(national_level_standard) + 2*sd(national_level_standard)),
                width = 0, color = "#E37B1C") +
  geom_text(aes(x = Inf, y = mean(national_level_standard), label = "Standard MRP"), 
            hjust = -.05, size = 4, color = "#E37B1C") +
  geom_point(aes(y = mean(national_level_idealpoint), x = .75), color = "#7B1CE3") +
  geom_errorbar(aes(y = mean(national_level_idealpoint), 
                x = .75, 
                ymin = mean(national_level_idealpoint) - 2*sd(national_level_idealpoint),
                ymax = mean(national_level_idealpoint) + 2*sd(national_level_idealpoint)),
                width = 0, color = "#7B1CE3") +
  geom_text(aes(x = Inf, y = mean(national_level_idealpoint), label = "IdealPoint MRP"), 
            hjust = -.05, size = 4, color = "#7B1CE3") +
  geom_point(aes(y=national_level_all, x = .5), color = "#1CE37B") +
  geom_errorbar(aes(y = national_level_all, 
                x = .5, 
                ymin = national_level_all - 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all)),
                ymax = national_level_all + 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all))),
                width = 0, color = "#1CE37B") +
  geom_text(data = data.frame(), aes(x = Inf, y = national_level_all, label = "Complete Survey"), 
            hjust = -.06, size = 4, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1),
                     labels=c("0%","25%","50%","75%","100%"),
                     limits=c(0,1),expand=c(0,0))+
  scale_x_continuous(limits=c(0,1),expand=c(0,0), breaks=c(.25, .75)) +
  coord_cartesian(clip = 'off') +
  theme_bw()+
  labs(x="Population",y="")+
   theme(legend.position="none",
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=10, margin = margin(t = 19, r = 0, b = , l = 0)),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10),
        plot.margin = margin(5.5, 105, 5.5, 5.5, "pt")
        )

bayesplot::bayesplot_grid(compare1,compare2, 
               grid_args = list(nrow=1, widths = c(5,1.4)))
```

### Question 2

```{r, echo=FALSE}
# fit_standard2 <- stan_glmer(abortion2 ~ (1 | state) + (1 | age) + (1 | ethnicity) + (1 | educ) + male +
#                      repvote + (1 | region),
#    family = binomial(link = "logit"),
#    data = left_join(df, statelevel_predictors),
#    prior = normal(0, 1, autoscale = TRUE),
#    prior_covariance = decov(scale = 0.50),
#    adapt_delta = 0.99,
#    seed = 1010)
# 
# saveRDS(fit_standard2, file = "fit_standard2.rds")
fit_standard2 <- readRDS("fit_standard2.rds")

P <- posterior_epred(fit_standard2, newdata = left_join(postrat_df, statelevel_predictors))
```

```{r, echo=FALSE}
national_level_standard <- P %*% postrat_df$n / sum(postrat_df$n)

df_state_standard <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (P[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]))
  df_state_standard$state[i] <- s
  df_state_standard$state_mean[i] <- mean(state_estimates)
  df_state_standard$state_sd[i] <- sd(state_estimates)
  i = i + 1
}


national_level_idealpoint <- df_fit$abortion2_pred %*% postrat_df$n / sum(postrat_df$n)

df_state_idealpoint <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$abortion2_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
  sum(postrat_df$n[which(postrat_df$state==s)]) )
  df_state_idealpoint$state[i] <- s
  df_state_idealpoint$state_mean[i] <- mean(state_estimates)
  df_state_idealpoint$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

national_level_all <- mean(df$abortion2)
df_state_all <- df_all %>% group_by(state) %>% summarise(state_mean = mean(abortion2), n = n())

```

> Ban abortions after the 20th week of pregnancy

```{r, fig.height= 3.5, fig.width=12, echo=FALSE, fig.align = "center"}
df_state_standard$state <- fct_reorder(df_state_standard$state, statelevel_predictors$repvote)

compare1 <- ggplot(data=df_state_standard) +
  geom_point(aes(x=state, y=state_mean), color = "#E37B1C") +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0, color = "#E37B1C") +
  geom_point(data=df_state_idealpoint, aes(x=state, y=state_mean), color = "#7B1CE3") +
  geom_errorbar(data=df_state_idealpoint, 
                aes(ymin=state_mean - 2*state_sd, 
                    ymax=state_mean + 2*state_sd, 
                    x=state), 
                alpha=.5, width = 0, color = "#7B1CE3") +
  geom_point(data = df_state_all, aes(x=state, y=state_mean), color = "#1CE37B") +
  geom_errorbar(data = df_state_all, 
                aes(ymin=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    ymax=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    x=state), alpha=.5, width = 0, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1), 
                     labels=c("0%","25%","50%","75%","100%"), 
                     expand=c(0,0))+
  coord_cartesian(ylim=c(0, 1)) +
  theme_bw()+
  labs(x="States",y="Support")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

compare2 <- ggplot(data = data.frame())+
  geom_point(aes(y=mean(national_level_standard), x = .25), color = "#E37B1C") +
  geom_errorbar(aes(y = mean(national_level_standard), 
                x = .25,
                ymin = mean(national_level_standard) - 2*sd(national_level_standard),
                ymax = mean(national_level_standard) + 2*sd(national_level_standard)),
                width = 0, color = "#E37B1C") +
  geom_text(aes(x = Inf, y = mean(national_level_standard), label = "Standard MRP"), 
            hjust = -.05, size = 4, color = "#E37B1C") +
  geom_point(aes(y = mean(national_level_idealpoint), x = .75), color = "#7B1CE3") +
  geom_errorbar(aes(y = mean(national_level_idealpoint), 
                x = .75, 
                ymin = mean(national_level_idealpoint) - 2*sd(national_level_idealpoint),
                ymax = mean(national_level_idealpoint) + 2*sd(national_level_idealpoint)),
                width = 0, color = "#7B1CE3") +
  geom_text(aes(x = Inf, y = mean(national_level_idealpoint), label = "IdealPoint MRP"), 
            hjust = -.05, size = 4, color = "#7B1CE3") +
  geom_point(aes(y=national_level_all, x = .5), color = "#1CE37B") +
  geom_errorbar(aes(y = national_level_all, 
                x = .5, 
                ymin = national_level_all - 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all)),
                ymax = national_level_all + 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all))),
                width = 0, color = "#1CE37B") +
  geom_text(data = data.frame(), aes(x = Inf, y = national_level_all, label = "Complete Survey"), 
            hjust = -.06, size = 4, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1),
                     labels=c("0%","25%","50%","75%","100%"),
                     limits=c(0,1),expand=c(0,0))+
  scale_x_continuous(limits=c(0,1),expand=c(0,0), breaks=c(.25, .75)) +
  coord_cartesian(clip = 'off') +
  theme_bw()+
  labs(x="Population",y="")+
   theme(legend.position="none",
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=10, margin = margin(t = 19, r = 0, b = , l = 0)),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10),
        plot.margin = margin(5.5, 105, 5.5, 5.5, "pt")
        )

bayesplot::bayesplot_grid(compare1,compare2, 
               grid_args = list(nrow=1, widths = c(5,1.4)))
```

### Question 3

```{r, echo=FALSE}
# fit_standard3 <- stan_glmer(abortion3 ~ (1 | state) + (1 | age) + (1 | ethnicity) + (1 | educ) + male +
#                      repvote + (1 | region),
#    family = binomial(link = "logit"),
#    data = left_join(df, statelevel_predictors),
#    prior = normal(0, 1, autoscale = TRUE),
#    prior_covariance = decov(scale = 0.50),
#    adapt_delta = 0.99,
#    seed = 1010)
# 
# saveRDS(fit_standard3, file = "fit_standard3.rds")
fit_standard3 <- readRDS("fit_standard3.rds")

P <- posterior_epred(fit_standard3, newdata = left_join(postrat_df, statelevel_predictors))
```

```{r, echo=FALSE}
national_level_standard <- P %*% postrat_df$n / sum(postrat_df$n)

df_state_standard <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (P[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]))
  df_state_standard$state[i] <- s
  df_state_standard$state_mean[i] <- mean(state_estimates)
  df_state_standard$state_sd[i] <- sd(state_estimates)
  i = i + 1
}


national_level_idealpoint <- df_fit$abortion3_pred %*% postrat_df$n / sum(postrat_df$n)

df_state_idealpoint <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$abortion3_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
  sum(postrat_df$n[which(postrat_df$state==s)]) )
  df_state_idealpoint$state[i] <- s
  df_state_idealpoint$state_mean[i] <- mean(state_estimates)
  df_state_idealpoint$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

national_level_all <- mean(df$abortion3)
df_state_all <- df_all %>% group_by(state) %>% summarise(state_mean = mean(abortion3), n = n())

```

> Allow employers to decline coverage of abortions in insurance plans

```{r, fig.height= 3.5, fig.width=12, echo=FALSE, fig.align = "center"}
df_state_standard$state <- fct_reorder(df_state_standard$state, statelevel_predictors$repvote)

compare1 <- ggplot(data=df_state_standard) +
  geom_point(aes(x=state, y=state_mean), color = "#E37B1C") +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0, color = "#E37B1C") +
  geom_point(data=df_state_idealpoint, aes(x=state, y=state_mean), color = "#7B1CE3") +
  geom_errorbar(data=df_state_idealpoint, 
                aes(ymin=state_mean - 2*state_sd, 
                    ymax=state_mean + 2*state_sd, 
                    x=state), 
                alpha=.5, width = 0, color = "#7B1CE3") +
  geom_point(data = df_state_all, aes(x=state, y=state_mean), color = "#1CE37B") +
  geom_errorbar(data = df_state_all, 
                aes(ymin=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    ymax=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    x=state), alpha=.5, width = 0, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1), 
                     labels=c("0%","25%","50%","75%","100%"), 
                     expand=c(0,0))+
  coord_cartesian(ylim=c(0, 1)) +
  theme_bw()+
  labs(x="States",y="Support")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

compare2 <- ggplot(data = data.frame())+
  geom_point(aes(y=mean(national_level_standard), x = .25), color = "#E37B1C") +
  geom_errorbar(aes(y = mean(national_level_standard), 
                x = .25,
                ymin = mean(national_level_standard) - 2*sd(national_level_standard),
                ymax = mean(national_level_standard) + 2*sd(national_level_standard)),
                width = 0, color = "#E37B1C") +
  geom_text(aes(x = Inf, y = mean(national_level_standard), label = "Standard MRP"), 
            hjust = -.05, size = 4, color = "#E37B1C") +
  geom_point(aes(y = mean(national_level_idealpoint), x = .75), color = "#7B1CE3") +
  geom_errorbar(aes(y = mean(national_level_idealpoint), 
                x = .75, 
                ymin = mean(national_level_idealpoint) - 2*sd(national_level_idealpoint),
                ymax = mean(national_level_idealpoint) + 2*sd(national_level_idealpoint)),
                width = 0, color = "#7B1CE3") +
  geom_text(aes(x = Inf, y = mean(national_level_idealpoint), label = "IdealPoint MRP"), 
            hjust = -.05, size = 4, color = "#7B1CE3") +
  geom_point(aes(y=national_level_all, x = .5), color = "#1CE37B") +
  geom_errorbar(aes(y = national_level_all, 
                x = .5, 
                ymin = national_level_all - 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all)),
                ymax = national_level_all + 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all))),
                width = 0, color = "#1CE37B") +
  geom_text(data = data.frame(), aes(x = Inf, y = national_level_all, label = "Complete Survey"), 
            hjust = -.06, size = 4, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1),
                     labels=c("0%","25%","50%","75%","100%"),
                     limits=c(0,1),expand=c(0,0))+
  scale_x_continuous(limits=c(0,1),expand=c(0,0), breaks=c(.25, .75)) +
  coord_cartesian(clip = 'off') +
  theme_bw()+
  labs(x="Population",y="")+
   theme(legend.position="none",
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=10, margin = margin(t = 19, r = 0, b = , l = 0)),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10),
        plot.margin = margin(5.5, 105, 5.5, 5.5, "pt")
        )

bayesplot::bayesplot_grid(compare1,compare2, 
               grid_args = list(nrow=1, widths = c(5,1.4)))
```

### Question 4

```{r, echo=FALSE}
# fit_standard4 <- stan_glmer(abortion4 ~ (1 | state) + (1 | age) + (1 | ethnicity) + (1 | educ) + male +
#                      repvote + (1 | region),
#    family = binomial(link = "logit"),
#    data = left_join(df, statelevel_predictors),
#    prior = normal(0, 1, autoscale = TRUE),
#    prior_covariance = decov(scale = 0.50),
#    adapt_delta = 0.99,
#    seed = 1010)
# 
# saveRDS(fit_standard4, file = "fit_standard4.rds")
fit_standard4 <- readRDS("fit_standard4.rds")

P <- posterior_epred(fit_standard4, newdata = left_join(postrat_df, statelevel_predictors))
```

```{r, echo=FALSE}
national_level_standard <- P %*% postrat_df$n / sum(postrat_df$n)

df_state_standard <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (P[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
    sum(postrat_df$n[which(postrat_df$state==s)]))
  df_state_standard$state[i] <- s
  df_state_standard$state_mean[i] <- mean(state_estimates)
  df_state_standard$state_sd[i] <- sd(state_estimates)
  i = i + 1
}


national_level_idealpoint <- df_fit$abortion4_pred %*% postrat_df$n / sum(postrat_df$n)

df_state_idealpoint <- data.frame(state = rep(NA, length(levels(df$state))),
                       state_mean = rep(NA, length(levels(df$state))),
                       state_sd = rep(NA, length(levels(df$state))))
i = 1
for(s in levels(df$state)){
  state_estimates <- (df_fit$abortion4_pred[, which(postrat_df$state==s)] %*% postrat_df$n[which(postrat_df$state==s)]/
  sum(postrat_df$n[which(postrat_df$state==s)]) )
  df_state_idealpoint$state[i] <- s
  df_state_idealpoint$state_mean[i] <- mean(state_estimates)
  df_state_idealpoint$state_sd[i] <- sd(state_estimates)
  i = i + 1
}

national_level_all <- mean(df$abortion4)
df_state_all <- df_all %>% group_by(state) %>% summarise(state_mean = mean(abortion4), n = n())

```

> Prohibit the expenditure of funds authorized or appropriated by federal law for any abortion

```{r, fig.height= 3.5, fig.width=12, echo=FALSE, fig.align = "center"}
df_state_standard$state <- fct_reorder(df_state_standard$state, statelevel_predictors$repvote)

compare1 <- ggplot(data=df_state_standard) +
  geom_point(aes(x=state, y=state_mean), color = "#E37B1C") +
  geom_errorbar(aes(ymin=state_mean - 2*state_sd,
                    ymax=state_mean + 2*state_sd,
                    x=state), alpha=.5, width = 0, color = "#E37B1C") +
  geom_point(data=df_state_idealpoint, aes(x=state, y=state_mean), color = "#7B1CE3") +
  geom_errorbar(data=df_state_idealpoint, 
                aes(ymin=state_mean - 2*state_sd, 
                    ymax=state_mean + 2*state_sd, 
                    x=state), 
                alpha=.5, width = 0, color = "#7B1CE3") +
  geom_point(data = df_state_all, aes(x=state, y=state_mean), color = "#1CE37B") +
  geom_errorbar(data = df_state_all, 
                aes(ymin=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    ymax=state_mean - 2*sqrt((state_mean*(1-state_mean))/n), 
                    x=state), alpha=.5, width = 0, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1), 
                     labels=c("0%","25%","50%","75%","100%"), 
                     expand=c(0,0))+
  coord_cartesian(ylim=c(0, 1)) +
  theme_bw()+
  labs(x="States",y="Support")+
  theme(legend.position="none",
        axis.title=element_text(size=10),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(angle=90,size=8, vjust=0.3),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10))

compare2 <- ggplot(data = data.frame())+
  geom_point(aes(y=mean(national_level_standard), x = .25), color = "#E37B1C") +
  geom_errorbar(aes(y = mean(national_level_standard), 
                x = .25,
                ymin = mean(national_level_standard) - 2*sd(national_level_standard),
                ymax = mean(national_level_standard) + 2*sd(national_level_standard)),
                width = 0, color = "#E37B1C") +
  geom_text(aes(x = Inf, y = mean(national_level_standard), label = "Standard MRP"), 
            hjust = -.05, size = 4, color = "#E37B1C") +
  geom_point(aes(y = mean(national_level_idealpoint), x = .75), color = "#7B1CE3") +
  geom_errorbar(aes(y = mean(national_level_idealpoint), 
                x = .75, 
                ymin = mean(national_level_idealpoint) - 2*sd(national_level_idealpoint),
                ymax = mean(national_level_idealpoint) + 2*sd(national_level_idealpoint)),
                width = 0, color = "#7B1CE3") +
  geom_text(aes(x = Inf, y = mean(national_level_idealpoint), label = "IdealPoint MRP"), 
            hjust = -.05, size = 4, color = "#7B1CE3") +
  geom_point(aes(y=national_level_all, x = .5), color = "#1CE37B") +
  geom_errorbar(aes(y = national_level_all, 
                x = .5, 
                ymin = national_level_all - 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all)),
                ymax = national_level_all + 2*sqrt((national_level_all*(1-national_level_all))/nrow(df_all))),
                width = 0, color = "#1CE37B") +
  geom_text(data = data.frame(), aes(x = Inf, y = national_level_all, label = "Complete Survey"), 
            hjust = -.06, size = 4, color = "#1CE37B") +
  scale_y_continuous(breaks=c(0,.25,.5,.75,1),
                     labels=c("0%","25%","50%","75%","100%"),
                     limits=c(0,1),expand=c(0,0))+
  scale_x_continuous(limits=c(0,1),expand=c(0,0), breaks=c(.25, .75)) +
  coord_cartesian(clip = 'off') +
  theme_bw()+
  labs(x="Population",y="")+
   theme(legend.position="none",
        axis.title.y=element_blank(),
        axis.title.x=element_text(size=10, margin = margin(t = 19, r = 0, b = , l = 0)),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        legend.title=element_text(size=10),
        legend.text=element_text(size=10),
        plot.margin = margin(5.5, 105, 5.5, 5.5, "pt")
        )

bayesplot::bayesplot_grid(compare1,compare2, 
               grid_args = list(nrow=1, widths = c(5,1.4)))
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}


```

```{r}


```

```{r}


```

```{r}


```

```{r}


```

```{r}


```
